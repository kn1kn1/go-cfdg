<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Context Free Art Playground</title>

  <link rel="shortcut icon" href="image/favicon.ico" type="image/vnd.microsoft.icon" />
  <link rel="icon" href="image/favicon.ico" type="image/vnd.microsoft.icon" />

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">

  <script src="js/codemirror.js"></script>
  <script src="js/cfdg-examples.js"></script>
  <link rel="stylesheet" href="css/codemirror.css">
  <style>
    .CodeMirror {
      height: auto;
      border: 1px solid #ddd;
    }

    .CodeMirror-scroll {
      max-height: 500px;
    }

    .CodeMirror pre {
      padding-left: 7px;
      line-height: 1.25;
    }
  </style>
  <style type="text/css">
    .rightJustified {
      text-align: right;
    }
  </style>

  <script>
    $(document).ready(function() {
      var idx;
      for (idx in CFDG.examples) {
        var title = CFDG.examples[idx].title;
        $('#examples').append($('<option>').html(title).val(idx));
      }
      var selectedIdx = 5;
      var initialCode = CFDG.examples[selectedIdx].code;
      var previousCode = initialCode;

      var count = 0;
      var codearea = document.getElementById("code");
      codearea.value = initialCode;
      var editor = CodeMirror.fromTextArea(codearea, {
        lineNumbers: true
      });

      $('#renderButton').click(function() {
        $('#output').empty();
        render();
      })

      var variation = 'A';
      var dirty = false;
      $('#variation').val(variation);
      $('#variation').keydown(function(e) {
        dirty = true;
        return alphaOnly(e);
      });

      function alphaOnly(event) {
        var key = event.keyCode;
        return ((key >= 65 && key <= 90) || key == 8 || (key >= 37 && key <= 40));
      };

      function onSelectedExampleChanged() {
        var selectedIdx = $('#examples').val();
        editor.setValue(CFDG.examples[selectedIdx].code);
        $('#output').empty();
        render();
      };

      $('#examples').change(onSelectedExampleChanged);

      function render() {
        var code = editor.getValue();
        var encoded = encodeURIComponent(code);
        var checkUrl = 'check?code=' + encoded;
        $.ajax(checkUrl)
          .done(function(data) {
            if (data && data["Error"]) {
              previousCode = code;
              var err = $('<p>', {
                id: 'err'
              }).css({
                padding: '2px',
                backgroundColor: 'yellow'
              });
              err.append(document.createTextNode(data["Message"]));
              $('#output').append(err);
              return;
            }

            var varVal = $('#variation').val();
            if (dirty && varVal !== variation) {
              variation = varVal.toUpperCase();
            } else if (count !== 0 && previousCode === code) {
              variation = add1(variation);
            }
            dirty = false;
            previousCode = code;
            $('#variation').val(variation);

            // var renderUrl = 'https://cfdg.herokuapp.com/render?code=' + encoded + '&v=' + variation;
            var renderUrl = 'render?code=' + encoded + '&v=' + variation;

            count++;
            $('#output').append($('<img>', {
              id: 'theImg',
              src: renderUrl
            }));
          })
          .fail(function(jqXHR) {
            previousCode = code;
            var err = $('<p>', {
              id: 'err'
            }).css({
              padding: '2px',
              backgroundColor: 'yellow'
            });
            err.append(document.createTextNode("status: " + jqXHR.status + ", statusText: " + jqXHR.statusText + ", url: " + checkUrl));
            $('#output').append(err);
            return;
          });
      }

      function add1(str) {
        var codes, valueLen, i, carry, charCode, code, len, newValue;
        str = str.toUpperCase();
        codes = [];
        valueLen = str.length;
        for (i = 0, valueLen; i < valueLen; i++) {
          codes[i] = str.charCodeAt(i);
        }
        carry = 1;
        for (i = valueLen - 1; i >= 0; i--) {
          charCode = codes[i];
          charCode = charCode + carry;
          if (charCode > 90) {
            codes[i] = 65;
            carry = 1;
          } else {
            codes[i] = charCode;
            carry = 0;
          }
        }
        if ((carry === 1) && (valueLen === 6)) {
          return 'A';
        }
        newValue = carry === 1 ? 'A' : '';
        for (i = 0, len = codes.length; i < len; i++) {
          code = codes[i];
          newValue = newValue + String.fromCharCode(code);
        }
        return newValue;
      };

      $('#examples').val(selectedIdx);
      onSelectedExampleChanged();

    });
  </script>
</head>

<body style="padding-top: 10px">
  <div class="container">
    <h1>Context Free Art Playground</h1>
  </div>
  <div class="container">
    <div class="row" style="padding: 5px">
      <div class="col-md-6">
        <textarea id="code" name="code"></textarea>
        <div style="padding-top: 5px">
          <select id="examples" name="examples">
          </select>
        </div>
        <div style="padding: 5px">
          <b>Variation</b> ('A'-'ZZZZZZ')
          <input type="text" id="variation" maxlength="6" class="rightJustified">
        </div>
        <div style="padding-top: 10px">
          <input type="button" value="Render" id="renderButton">
        </div>
      </div>
      <div id="output" class="col-md-6"></div>
    </div>
    <div class="row" style="padding: 5px">
      <center><a href="https://github.com/kn1kn1/go-cfdg">Project Home at GitHub</a></center>
    </div>
  </div>
</body>

</html>
